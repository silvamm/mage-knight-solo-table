<!DOCTYPE html>
<html lang="en">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0"/>
    <meta name="apple-mobile-web-app-capable" content="yes"/>
    <meta name="apple-mobile-web-app-status-bar-style" content="black"/>
    <meta name="description" content="Mage Knight Dummy Player">
    <meta name="keywords" content="mage,knight,dummy,player,app,solo,cooperative">
    <link rel="apple-touch-icon" href="content/icon.png"/>
    <link rel="icon" href="content/icon.png"/>
    <meta charset="UTF-8">
    <title>Mage Knight Solo Table</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
</head>
<style>
    .can-active {
        cursor: pointer;
    }
</style>
<body class="bg-dark">
<h1></h1>

<div class="container text-center">
    <div class="row mb-3">
        <div class="col">
            <button onclick="ui.night()">Night</button>
            <button onclick="ui.day()">Day</button>
            <button class="btn btn-dark rounded-0" type="button" data-bs-toggle="offcanvas"
                    data-bs-target="#referencesOffcanvas" aria-controls="referencesOffcanvas">
                References
            </button>
            <button class="btn btn-dark rounded-0" type="button" data-bs-toggle="offcanvas"
                    data-bs-target="#logsOffcanvas" aria-controls="logsOffcanvas">
                Logs
            </button>
            <button class="btn btn-dark rounded-0" type="button" data-bs-toggle="offcanvas"
                    data-bs-target="#dummyPlayerOffcanvas" aria-controls="dummyPlayerOffcanvas">
                Dummy Player
            </button>

            <div class="offcanvas offcanvas-bottom bg-dark text-white" tabindex="-1" id="logsOffcanvas"
                 aria-labelledby="logsOffcanvasLabel">
                <div class="offcanvas-body">
                    <div id="logs"></div>
                </div>
            </div>

            <div class="offcanvas offcanvas-end bg-dark" style="width: 30%" tabindex="-1" id="dummyPlayerOffcanvas"
                 aria-labelledby="dummyPlayerOffcanvasLabel">
                <div class="offcanvas-body">
                    <iframe src="dummy_player.html" style="width: 100%; height: 100%;"></iframe>
                </div>
            </div>

            <div class="offcanvas offcanvas-start text-start bg-dark" style="width: 37%" tabindex="-1"
                 id="referencesOffcanvas"
                 aria-labelledby="referencesOffcanvasLabel">
                <div id="canvasBody" class="offcanvas-body ">
                    <div class="accordion accordion-flush " id="accordionReferences">
                        <script>
                            let references = ['ancient_ruins', 'city', 'draconum', 'dungeon', 'end_turn', 'glade', 'grounds', 'keep', 'mage_tower', 'mines', 'monastery', 'monster_den', 'orcs', 'round', 'tomb', 'village']
                            let i = 1
                            references.forEach(reference => {
                                reference_without_underscore = reference.replace('_', ' ')
                                capitalize = reference_without_underscore.charAt(0).toUpperCase() + reference_without_underscore.slice(1)
                                document.write(`
                                      <div class="accordion-item bg-dark">
                                            <h2 class="accordion-header">
                                                <button class="accordion-button collapsed bg-dark text-white" type="button" data-bs-toggle="collapse" data-bs-target="#collapse${i}" aria-expanded="true" aria-controls="collapse${i}">
                                                    ${capitalize}
                                                </button>
                                            </h2>
                                            <div id="collapse${i}" class="accordion-collapse collapse" data-bs-parent="#accordionReferences">
                                                <div class="accordion-body">
                                                    <img src="references/${reference}.png" class="img-fluid" alt="">
                                                </div>
                                            </div>
                                      </div>
                                    `)
                                i++
                            })
                        </script>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="row ">
        <div class="col">
            <div class="table-responsive">
                <table class="table table-dark table-borderless">
                    <thead>
                    <tr>
                        <th scope="col" class="col-1" style="font-size: 25px">☼</th>
                        <th scope="col" class="col-1" style="font-size: 25px">☽</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr>
                        <td id="day-score">0</td>
                        <td id="night-score">0</td>
                    </tr>
                    <tr>
                        <td colspan="2">
                            <table id="moves-table" class="table table-dark table-borderless">
                                <thead>
                                <tr>
                                    <th scope="col" class="col-1">Plains</th>
                                    <th scope="col" class="col-1">Hills</th>
                                    <th scope="col" class="col-1">Forest</th>
                                    <th scope="col" class="col-1">Desert</th>
                                    <th scope="col" class="col-1">Wastelands</th>
                                    <th scope="col" class="col-1">Marsh</th>
                                    <th scope="col" class="col-1">City</th>
                                    <th scope="col" class="col-1">Mountain</th>
                                    <th scope="col" class="col-1">Water</th>
                                </tr>
                                </thead>
                                <tr id="day-move-points">
                                    <td>2</td>
                                    <td>3</td>
                                    <td>3</td>
                                    <td>5</td>
                                    <td>4</td>
                                    <td>5</td>
                                    <td>2</td>
                                    <td>X</td>
                                    <td>X</td>
                                </tr>
                                <tr id="night-move-points">
                                    <td>2</td>
                                    <td>3</td>
                                    <td>5</td>
                                    <td>3</td>
                                    <td>4</td>
                                    <td>5</td>
                                    <td>2</td>
                                    <td>X</td>
                                    <td>X</td>
                                </tr>
                            </table>
                        </td>
                    </tbody>
                </table>
            </div>

            <hr class="text-white"/>

            <div class="table-responsive">
                <table class="table table-dark table-borderless ">
                    <thead>
                    <tr>
                        <th colspan="99">Reputation</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr>
                        <td colspan="99">
                            <div class="btn-group mb-3" role="group" aria-label="Basic outlined example">
                                <button type="button" class="btn btn-dark rounded-0"
                                        onclick="ui.updateReputation(-1)">-1
                                </button>
                                <button type="button" class="btn btn-dark rounded-0"
                                        onclick="ui.updateReputation(+1)">+1
                                </button>
                            </div>
                        </td>
                    </tr>
                    <script>
                        document.write('<tr>');
                        let reputations = [
                            {text: "X", value: -7},
                            {text: "-5", value: -6},
                            {text: "-3", value: -5},
                            {text: "-2", value: -4},
                            {text: "-1", value: -3},
                            {text: "-1", value: -2},
                            {text: "0", value: -1},
                            {text: "0", value: 0},
                            {text: "0", value: 1},
                            {text: "+1", value: 2},
                            {text: "+1", value: 3},
                            {text: "+2", value: 4},
                            {text: "+2", value: 5},
                            {text: "+3", value: 6},
                            {text: "+5", value: 7}
                        ];
                        for (let i = 0; i < reputations.length; i++) {
                            document.write(`<td class="can-active" style="width: 6.6%" data-value="${reputations[i].value}" id="reputation|${reputations[i].value}" onclick="ui.markReputationTracker(this)">${reputations[i].text}</td>`);
                        }
                        document.write('</tr>');
                    </script>
                    </tbody>
                </table>
                x
            </div>

            <hr class="text-white"/>

            <div class="table-responsive">
                <table class="table table-dark table-borderless">
                    <thead>
                    <tr>
                        <th colspan="99">Fame</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr>
                        <td colspan="99">
                            <div class="btn-group mb-3" role="group" aria-label="Basic outlined example">
                                <button type="button" class="btn btn-dark rounded-0" onclick="ui.updateFame(+2)">
                                    +2
                                </button>
                                <button type="button" class="btn btn-dark rounded-0" onclick="ui.updateFame(+3)">
                                    +3
                                </button>
                                <button type="button" class="btn btn-dark rounded-0" onclick="ui.updateFame(+4)">
                                    +4
                                </button>
                                <button type="button" class="btn btn-dark rounded-0" onclick="ui.updateFame(+5)">
                                    +5
                                </button>
                            </div>
                        </td>
                    </tr>
                    <script>
                        let number = 0;
                        for (let row = 1; number <= 119; row++) {
                            document.write('<tr>');
                            if (row % 2 === 1) {
                                document.write('<td style="font-size: 20px" ">⬡</td>');
                            } else {
                                document.write('<td style="font-size: 20px">▯▭</td>');
                            }
                            for (let col = 0; col < 3 + (row - 1) * 2 && number <= 119; col++) {
                                document.write(`<td class="can-active" id="fame|${number}" onclick="ui.markFameTracker(this)">${number}</td>`);
                                number++;
                            }
                            document.write('</tr>');
                        }
                    </script>
                    </tbody>
                </table>
            </div>
        </div>

    </div>
</div>
<script src="https://code.jquery.com/jquery-3.7.1.min.js"
        integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>
<script>
    let Strings = Object.freeze({
        StorageAppStateKey: "app-state"
    });



    function UIContext() {

        this.dayScore = null
        this.nightScore = null
        this.dayMovePoints = null
        this.nightMovePoints = null
        this.logs = null
        this.date = null
        this.currentReputation = null
        this.currentFame = null
        this.currentPeriod = null
        this.state = null

        this.emptyState = {
            night: {
                active: false,
                count: 0
            },
            day: {
                active: true,
                count: 1
            },
            reputation: {
                text: "0",
                value: 0
            },
            fame: 0,
            logs: ""
        }

        this.supports_html5_storage = function() {
            try {
                return 'localStorage' in window && window['localStorage'] !== null
            } catch (e) {
                return false
            }
        }

        this.save = function () {
            if (this.supports_html5_storage())
                localStorage.setItem(Strings.StorageAppStateKey, JSON.stringify(this.state))
        }

        this.getSavedState = function () {
            if (this.supports_html5_storage()){
                return JSON.parse(localStorage.getItem(Strings.StorageAppStateKey))
            }else{
                return null;
            }
        }

        this.initialize = function () {

            this.state = this.getSavedState() ?? this.emptyState

            this.currentReputation = document.getElementById(`reputation|${this.state.reputation.value}`)
            this.currentFame = document.getElementById(`fame|${this.state.fame}`)

            this.date = new Date()
            this.logs = document.getElementById('logs')
            this.logs.innerHTML = this.state.logs

            this.currentPeriod = this.state.day.active ? document.getElementById('day-score') : document.getElementById('night-score')

            this.dayScore = document.getElementById('day-score')
            this.dayMovePoints = document.getElementById('day-move-points')

            this.nightScore = document.getElementById('night-score')
            this.nightMovePoints = document.getElementById('night-move-points')

            if (this.state.day.active)
                this.day()

            if (this.state.night.active)
                this.night()

            this.markReputationTracker(this.currentReputation)
            this.markFameTracker(this.currentFame)

            document.querySelectorAll('td .can-active').forEach(td => {
                td.addEventListener('mouseover', function () {
                    this.classList.add('table-active')
                })
                td.addEventListener('mouseout', function () {
                    this.classList.remove('table-active')
                })
                td.addEventListener('click', function () {
                    this.classList.remove('table-active')
                })
            })

            $(".accordion-item").on("shown.bs.collapse", function () {
                var selected = $(this)
                var offcanvas = $('#canvasBody')
                if (selected.offset().top + selected.height() > offcanvas.offset().top + offcanvas.height()) {
                    var scrollTop = (selected.offset().top - offcanvas.offset().top + offcanvas.scrollTop()) - 10
                    offcanvas.animate({scrollTop: scrollTop}, 500)
                }
            });

        }

        this.log = function (message) {
            this.logs.insertAdjacentHTML('afterbegin', `<p>${this.date.toLocaleString()} - ${message}</p>`)
            this.state.logs = this.logs.innerHTML
        }

        this.markReputationTracker = function (newReputationElement) {
            this.addHighlight(newReputationElement)

            if (this.currentReputation === newReputationElement) return

            this.removeHighlight(this.currentReputation)

            let increasesOrDecreases = parseInt(newReputationElement.dataset.value) < parseInt(this.currentReputation.dataset.value) ? '↓' : '↑';
            this.log(`Reputation: ${this.currentReputation.textContent} → ${newReputationElement.textContent} ${increasesOrDecreases}`)

            this.state.reputation = {text: newReputationElement.textContent, value: newReputationElement.dataset.value}
            this.currentReputation = newReputationElement

            this.save()
        }

        this.markFameTracker = function (newFameElement) {
            this.addHighlight(newFameElement)

            if (this.currentFame === newFameElement) return

            this.removeHighlight(this.currentFame)

            this.log(`Fame: ${this.currentFame.textContent} → ${newFameElement.textContent}`)

            this.state.fame = newFameElement.textContent
            this.currentFame = newFameElement

            this.save()
        }

        this.show = function (element) {
            if (element != null)
                element.classList.remove("d-none")
        }

        this.hide = function (element) {
            if (element != null)
                element.classList.add("d-none")
        }

        this.addHighlight = function (element) {
            if (element != null)
                element.classList.add("bg-white", "text-dark")
        }
        this.removeHighlight = function (element) {
            if (element != null)
                element.classList.remove("bg-white", "text-dark")
        }

        this.night = function () {
            this.state.night.active = true
            this.addHighlight(this.nightScore)
            this.removeHighlight(this.dayScore)

            this.state.day.active = false
            this.hide(this.dayMovePoints)
            this.show(this.nightMovePoints)

            if(this.currentPeriod === this.nightScore && this.logs.textContent.length > 0) return

            this.log('The Night has begun')
            this.currentPeriod = this.nightScore

            this.save()
        }

        this.day = function () {
            this.state.day.active = true
            this.addHighlight(this.dayScore)
            this.show(this.dayMovePoints)

            this.state.night.active = false
            this.removeHighlight(this.nightScore)
            this.hide(this.nightMovePoints)

           if(this.currentPeriod === this.dayScore && this.logs.textContent.length > 0) return

            this.log('The Day has begun')
            this.currentPeriod = this.dayScore

            this.save()
        }

        this.updateReputation = function (number) {
            let newReputationNumber = Number(this.state.reputation.value) + number
            let newReputation = document.getElementById(`reputation|${newReputationNumber}`)

            if (newReputation === null) return

            this.markReputationTracker(newReputation)
        }

        this.updateFame = function (number) {
            let newFameNumber = Number(this.state.fame) + number
            let newFame = document.getElementById(`fame|${newFameNumber}`)

            if (newFame === null) return

            this.markFameTracker(newFame)
        }

    }

    let ui = new UIContext()
    ui.initialize()

</script>
</body>
</html>